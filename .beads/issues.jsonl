{"id":"obsidian-lilypond-8i3","title":"Multi-page sheet rendering (from PR #4 by @nchursin)","description":"Captured from open PR on original repo before ownership transfer.\n\n## Original PR\n\n- **Source:** https://github.com/dot-asterisk-nl/obsidian-lilypond/pull/4\n- **Title:** Render multiple page sheets\n- **Author:** Nikita Chursin (@nchursin, nichursin@ozon.ru)\n- **Branch:** main\n- **Created:** 2025-02-09\n- **Commits:**\n  - `9fb5508` render multiple files\n  - `2fd3112` promise all for multiple svg render\n\n## PR Description (verbatim)\n\n\u003e Hey!\n\u003e\n\u003e Awesome plugin, exactly what I was looking for!\n\u003e\n\u003e I had an issue rendering multi-page drum sheets — it just couldn't find the output file, cause lilypond generates multiple files in that case with a slightly different naming. I added multi-page rendering with this PR\n\n## Problem\n\nWhen lilypond renders a multi-page score (e.g. long drum sheets), it generates multiple SVG files with suffixed names (e.g. `file.svg`, `file-1.svg`, `file-2.svg`) instead of a single output file. The current code assumes a single output file and fails to find the output.\n\n## PR Analysis\n\n### What's good\n- Core fix is correct: collect all matching SVG files and render them together\n- Refactors to async/await (cleaner than .then()/.catch() chains)\n- Extracts helper functions: `collectFiles`, `renderSvgs`, `renderError`\n\n### What's questionable\n- **`pdf2html` dependency added** — appears unused. The PR uses SVG backend (`-dbackend=svg`), not PDF. This dependency seems like a leftover from an abandoned PDF approach and should NOT be included.\n- **Build script changed** from `tsc` to `./node_modules/typescript/bin/tsc` — this is a local environment workaround, not a proper fix. Should not be included.\n- **`package.json` whitespace reformatted** from tabs to spaces — clutters the diff with no functional change.\n\n### Attribution plan\nIf we implement this, credit Nikita Chursin with:\n```\nCo-Authored-By: Nikita Chursin \u003cnichursin@ozon.ru\u003e\n```\n","notes":"## Full Diff (preserved verbatim from https://github.com/dot-asterisk-nl/obsidian-lilypond/pull/4)\n\n### package.json\n\n```diff\ndiff --git a/package.json b/package.json\nindex 320ac81..0835b6d 100644\n--- a/package.json\n+++ b/package.json\n@@ -1,28 +1,29 @@\n {\n-\t\"name\": \"obsidian-lily\",\n-\t\"version\": \"1.0.1\",\n-\t\"description\": \"Lilypond support in Obsidian\",\n-\t\"main\": \"main.js\",\n-\t\"scripts\": {\n-\t\t\"dev\": \"node esbuild.config.mjs\",\n-\t\t\"build\": \"tsc -noEmit -skipLibCheck \u0026\u0026 node esbuild.config.mjs production\",\n-\t\t\"version\": \"node version-bump.mjs \u0026\u0026 git add manifest.json versions.json\"\n-\t},\n-\t\"keywords\": [],\n-\t\"author\": \"Dot-Asterisk\",\n-\t\"license\": \"MIT\",\n-\t\"devDependencies\": {\n-\t\t\"@types/node\": \"^16.11.6\",\n-\t\t\"@types/temp\": \"^0.9.1\",\n-\t\t\"@typescript-eslint/eslint-plugin\": \"^5.2.0\",\n-\t\t\"@typescript-eslint/parser\": \"^5.2.0\",\n-\t\t\"builtin-modules\": \"^3.2.0\",\n-\t\t\"esbuild\": \"0.13.12\",\n-\t\t\"obsidian\": \"latest\",\n-\t\t\"tslib\": \"2.3.1\",\n-\t\t\"typescript\": \"4.4.4\"\n-\t},\n-\t\"dependencies\": {\n-\t\t\"temp\": \"^0.9.4\"\n-\t}\n+  \"name\": \"obsidian-lily\",\n+  \"version\": \"1.0.1\",\n+  \"description\": \"Lilypond support in Obsidian\",\n+  \"main\": \"main.js\",\n+  \"scripts\": {\n+    \"dev\": \"node esbuild.config.mjs\",\n+    \"build\": \"./node_modules/typescript/bin/tsc -noEmit -skipLibCheck \u0026\u0026 node esbuild.config.mjs production\",\n+    \"version\": \"node version-bump.mjs \u0026\u0026 git add manifest.json versions.json\"\n+  },\n+  \"keywords\": [],\n+  \"author\": \"Dot-Asterisk\",\n+  \"license\": \"MIT\",\n+  \"devDependencies\": {\n+    \"@types/node\": \"^16.11.6\",\n+    \"@types/temp\": \"^0.9.1\",\n+    \"@typescript-eslint/eslint-plugin\": \"^5.2.0\",\n+    \"@typescript-eslint/parser\": \"^5.2.0\",\n+    \"builtin-modules\": \"^3.2.0\",\n+    \"esbuild\": \"0.13.12\",\n+    \"obsidian\": \"latest\",\n+    \"tslib\": \"2.3.1\",\n+    \"typescript\": \"4.4.4\"\n+  },\n+  \"dependencies\": {\n+    \"pdf2html\": \"^3.1.0\",\n+    \"temp\": \"^0.9.4\"\n+  }\n }\n```\n\n**package.json changes:** Whitespace tabs to spaces (cosmetic), added pdf2html dep (unused — see analysis below), changed build script to ./node_modules/typescript/bin/tsc (local env workaround).\n\n### src/lilypond.ts\n\n```diff\ndiff --git a/src/lilypond.ts b/src/lilypond.ts\nindex 7810718..511c05c 100644\n--- a/src/lilypond.ts\n+++ b/src/lilypond.ts\n@@ -21,20 +21,51 @@ export const render = async function (\n \tfs.closeSync(lyFile.fd);\n\n \tconst lyFileDir = path.join(lyFile.path, \"..\");\n-\texec(`${lilypondPath} -dbackend=svg -dpoint-and-click=false -fsvg --silent --output=${lyFileDir} ${lyFile.path}`)\n-\t.then(() =\u003e {\n-\t\tconst outputPath = lyFile.path.substring(0, lyFile.path.lastIndexOf(\".ly\")).concat(\".svg\");\n-\t\tel.innerHTML = fs.readFileSync(outputPath, {encoding: \"utf8\", flag: \"r\"});\n-\t})\n-\t.catch((error) =\u003e {\n-\t\tconsole.error(error);\n+\ttry {\n+\t\tawait exec(`${lilypondPath} -dbackend=svg -dpoint-and-click=false -fsvg --silent --output=${lyFileDir} ${lyFile.path}`)\n\n-\t\tconst paragraph = document.createElement(\"p\");\n-\t\tparagraph.classList.add(\"lily-error\");\n-\t\tparagraph.innerHTML = error;\n-\t\tparagraph.style.whiteSpace = \"pre-wrap\";\n+\t\tconst outputPaths = collectFiles(lyFile.path)\n\n-\t\tel.innerHTML = paragraph.innerHTML;\n-\t});\n+\t\tconst htmls = await renderSvgs(outputPaths)\n\n+\t\tel.innerHTML = htmls.join(\"\u003cbr/\u003e\u003cbr/\u003e\")\n+\t} catch (error) {\n+\t\tconsole.error(error);\n+\t\trenderError(error, el)\n+\t}\n };\n+\n+const renderSvgs = async (files: string[]): Promise\u003cstring[]\u003e =\u003e {\n+\tconst htmls = await Promise.all(\n+\t\tfiles.map(\n+\t\t\t(path) =\u003e fs.promises.readFile(path, { encoding: \"utf8\", flag: \"r\" }),\n+\t\t),\n+\t)\n+\treturn htmls\n+}\n+\n+const collectFiles = (lyFilePath: string): string[] =\u003e {\n+\tconst fileNameNoExt = path.join(path.dirname(lyFilePath), path.basename(lyFilePath, '.ly'))\n+\n+\tconst dirName = lyFilePath.substring(0, lyFilePath.lastIndexOf(\"/\"))\n+\n+\tconst outputPaths = fs.readdirSync(dirName)\n+\t\t.filter(f =\u003e path.basename(f).contains(path.basename(fileNameNoExt)) \u0026\u0026 f.endsWith('.svg'))\n+\t\t.sort()\n+\t\t.map((f) =\u003e path.join(dirName, f))\n+\n+\tif (!outputPaths.length) {\n+\t\tthrow `no output files found for ${lyFilePath}!`\n+\t}\n+\n+\treturn outputPaths\n+}\n+\n+const renderError = (error: string, el: HTMLElement) =\u003e {\n+\tconst paragraph = document.createElement(\"p\");\n+\tparagraph.classList.add(\"lily-error\");\n+\tparagraph.innerHTML = error;\n+\tparagraph.style.whiteSpace = \"pre-wrap\";\n+\n+\tel.innerHTML = paragraph.innerHTML;\n+}\n```\n\n**Core change:** Instead of assuming a single .svg output, collectFiles scans the output directory for all SVGs matching the input filename, sorts them, and renderSvgs reads them all asynchronously. Multiple pages are joined with line breaks.\n\n## Review Analysis\n\n### What is good\n- Core fix is correct: collect all matching SVG files and render them together\n- Refactors to async/await (cleaner than .then()/.catch() chains)\n- Extracts helper functions: collectFiles, renderSvgs, renderError\n\n### What is questionable\n- **pdf2html dependency added** — appears unused. The PR uses SVG backend (-dbackend=svg), not PDF. This dependency seems like a leftover from an abandoned PDF approach and should NOT be included.\n- **Build script changed** from tsc to ./node_modules/typescript/bin/tsc — this is a local environment workaround, not a proper fix. Should not be included.\n- **package.json whitespace reformatted** from tabs to spaces — clutters the diff with no functional change.\n\n### Implementation recommendation\nWhen implementing, take only the core logic:\n1. The collectFiles approach (scan dir for matching SVGs)\n2. The async/await refactor\n3. The multi-file rendering with renderSvgs\n\nSkip: pdf2html dep, build script change, package.json reformatting.\n\n### Attribution\nCredit Nikita Chursin with: Co-Authored-By: Nikita Chursin \u003cnichursin@ozon.ru\u003e","status":"open","priority":2,"issue_type":"feature","owner":"egorgromyko@gmail.com","created_at":"2026-02-11T13:00:26.286113+01:00","created_by":"Egor Gromyko","updated_at":"2026-02-11T15:43:37.677511+01:00"}
{"id":"obsidian-lilypond-lq6","title":"Add search path for includes","description":"From original repo issue #2 by @Chlorie:\n\nIt would be nice if the directory that the current `.md` file resides in could be added into the include search path when invoking the lilypond executable, so that I can put some commonly used scripts just in the Obsidian notes directory and use relative paths to include them, instead of absolute paths.","status":"open","priority":2,"issue_type":"feature","owner":"egorgromyko@gmail.com","created_at":"2026-02-11T12:52:35.083935+01:00","created_by":"Egor Gromyko","updated_at":"2026-02-11T12:52:35.083935+01:00"}
{"id":"obsidian-lilypond-oo3","title":"Make \\\\include \"lilypond-book-preamble.ly\" default","description":"From original repo issue #3 by @gianmarialari:\n\nMy snippets are always very short so I always add, at the top of my lilypond code `\\include \"lilypond-book-preamble.ly\"`\n\nIs there no way to achieve the same thing automatically without explicitly specifying this directive in each of my snippets?","status":"open","priority":2,"issue_type":"feature","owner":"egorgromyko@gmail.com","created_at":"2026-02-11T12:52:34.128492+01:00","created_by":"Egor Gromyko","updated_at":"2026-02-11T12:52:34.128492+01:00"}
